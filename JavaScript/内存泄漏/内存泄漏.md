# 内存泄漏

**垃圾回收**：JavaScript程序运行时，需要对变量分配内存空间，当变量不在使用时，需要系统回收被占用的内存空间，被称为垃圾回收

**内存泄漏**：程序中动态分配的内存因为某些原因未释放或者无法释放。

## JavaScript的垃圾回收机制

* 标记清除

  当变量进入执行环境时，会被标记为“进入环境”，当变量离开执行环境之后，会被标记为“离开环境”，被标记为“离开环境”的变量会被内存释放。

* 引用计数

  当内存中的变量被引用次数为0时，会被垃圾回收机制回收。

  这种方法会产生循环引用的问题

  ~~~javascript
  function fun() {
      let obj1 = {};
      let obj2 = {};
      obj1.a = obj2; // obj1 引用 obj2
      obj2.a = obj1; // obj2 引用 obj1
  }
  ~~~

  当变量通过属性相互引用时，该变量的引用计数都是2，此时无法被垃圾回收机制回收，造成内存泄漏。

## 哪些情况导致内存泄漏

* **意外的全局变量**

  使用未声明的变量，导致生成一个全局变量，从而无法被垃圾回收机制回收

* **闭包**

  不合理的使用闭包，导致某些变量一直存在内存当中

* **DOM元素的引用**

  获取一个DOM元素的引用，当这个DOM元素被删除时，仍会一直保留对该DOM元素的引用，所以无法被回收

* **被遗忘的计时器或回调函数**

  设置了一个计时器，但是忘记取消计时器，当循环函数存在对外部变量的使用时，该变量会一直存在内存当中，无法被回收。

