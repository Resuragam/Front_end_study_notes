## 浏览器缓存

### 1. 对浏览器的缓存机制的理解

浏览器缓存主要分为强缓存和协商缓存。

**浏览器缓存全过程：**

* 浏览器在第一次加载资源时，服务器会返回200状态码，浏览器从服务器上下载资源文件，并缓存资源文件与`Response Header`，以便于下次加载时进行比对。
* 浏览器再次加载资源时，首先会进行强缓存的判定。系统会先比较本次请求与上次200请求的时间差，再与`cache-control`中的`max-age`字段进行比较，如果没有超过，说明缓存没有过期，直接从本地读取缓存文件。如果浏览器不支持`HTTP1.1`，则使用 `expires`头判断是否过期。
* 如果资源未命中强缓存，会根据`no-cache`字段判定是否进行协商缓存，如果成功，向服务器发送带有`If-None-Match`和`If-Modified-Since`的请求。

* 首先判断`If-None-Match`，`If-None-Match`会存储第一个200请求的返回`Etag`值，如果`Etag`没有被更改，表示命中协商缓存，返回304；如果不一致则有改动，会返回新的文件和新的`Etag`值，并且返回200。
* 如果没有`Etag`值，就会根据`If-Modified-Since`和请求文件最后修改时间进行判断，如果一致表示命中协商缓存，返回304；如果不一致则有改动，会返回新的文件和新的`Last-Modified`值，并且返回200。

![业务流程图1.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f6837d8d1c74cf2894d8967a20115d9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

很多网站的资源后面都加了版本号，这样做的目的是：每次升级了 JS 或 CSS 文件后，为了防止浏览器进行缓存，强制改变版本号，客户端浏览器就会重新下载新的 JS 或 CSS 文件 ，以保证用户能够及时获得网站的最新更新。

### 2. 协商缓存和强缓存的区别

#### **强缓存**

使用强缓存策略时，如果缓存资源有效，直接使用强缓存，不需要重新向服务器发送请求。

强缓存策略可以通过两种方式来设置，分别是 `HTTP`头信息中的 `Expires` 属性和 `Cache-Control` 属性。

* 服务器在请求头中添加`Expires`属性，来指定资源的过期时间。在过期时间，表示该资源可以直接从缓存中使用，不需要重新从服务器下载。这个时间是一个绝对时间，采用服务器的时间，如果服务器时间和客户端的时间不一致时，会导致缓存失效。
* 在`HTTP1.1`中新增`Cache-control`属性，它可以提供对缓存资源更加可靠精确的控制。

`Cache-Control`可设置的字段：

* `public`：表示当前缓存资源可以被任意对象缓存。
* `private`：表示当前资源只能被用户端浏览器进行缓存，不允许代理服务器进行缓存。
* `max-age`：设置缓存的最大有效期，单位为秒。
* `no-cache`：设置当前缓存需要向服务器确定资源是否发生变化，如果没有变化，使用缓存好的资源。
* `no-store`：表示禁止使用缓存，每次都向服务器请求新的资源。

**no-cache和no-store很容易混淆：**

- no-cache 是指先要和服务器确认是否有资源更新，在进行判断。也就是说没有强缓存，但是会有协商缓存；
- no-store 是指不使用任何缓存，每次请求都直接从服务器获取资源。

#### **协商缓存**

协商缓存的条件：

* 超过缓存的最大有效期。
* 设置`no-cache`字段

协商缓存也可以通过两种方式来设置，分别是`HTTP`头信息中的**Etag** 和**Last-Modified**属性。

* 服务器向响应头中添加`Last-Modified`属性，指定资源上一次修改的时间，当浏览器再次请求资源时，会在请求头中加入`If-Modified-Since`属性，值为`Last-Modified`。该属性发到服务器会与最后一次修改的时间进行比较，因此判断资源是否更新。如果一致表示命中协商缓存，返回304；如果不一致则有改动，会返回新的文件和新的`Etag`值，并且返回200。该属性的单位为秒，如果一秒改变多次将无法检测，因此存在缺陷。
* 因为`Last-Modified`的这种可能发生的不准确性，`HTTP`中提供了另外一种方式，那就是`Etag`属性。服务器在返回资源的时候，在头信息中添加了`Etag`属性，这个属性是资源生成的唯一标识符，当资源发生改变的时候，这个值也会发生改变。在下一次资源请求时，浏览器会在请求头中添加一个`If-None-Match`属性，这个属性的值就是上次返回的资源的`Etag`的值。服务接收到请求后会根据这个值来和资源当前的`Etag`的值来进行比较，以此来判断资源是否发生改变，是否需要返回资源。通过这种方式，比`Last-Modified`的方式更加精确。

当`Last-Modified`和`Etag`属性同时出现的时候，`Etag`的优先级更高。使用协商缓存的时候，服务器需要考虑负载平衡的问题，因此多个服务器上资源的`Last-Modified`应该保持一致，因为每个服务器上`Etag`的值都不一样，因此在考虑负载平衡时，最好不要设置`Etag`属性。

### 3. 为什么需要浏览器缓存？

* 可以减轻服务器的负担，提高网站的性能。
* 加快了客户端的加载速度。
* 减少多余的网络数据传输。

### 4. 点击刷新按钮或者按 F5、按 Ctrl+F5 （强制刷新）、地址栏回车有什么区别？

* **点击刷新按钮或者按 F5：**浏览器会直接对本地的缓存文件过期，但是会带上`If-Modifed-Since`，`If-None-Match`，这意味浏览器会进行协商缓存处理。
* **用户按 Ctrl+F5（强制刷新）：** 浏览器不仅会对本地文件过期，而且不会带上`If-Modifed-Since`，`If-None-Match`，相当于之前从来没有请求过，返回结果是 200。
* 地址栏回车：浏览器发送请求，本地检查是否过期，然后服务器检查是否过期，返回内容。

