## 浏览器渲染原理

### 1. 浏览器的渲染过程

* 首先浏览器会解析`HTML`文件，生成`DOM`树，`DOM`树由`DOM`节点以及属性节点组成。
* 然后对`CSS`文件进行解析，生成`CSSOM`规则树。
* 根据`DOM`树和`CSSOM`规则树会生成渲染树，渲染树的每一个节点被称为渲染对象。每个渲染对象和`DOM`元素相对应，但是隐藏的`DOM`元素不会插入渲染树。
* 渲染对象被创建时，没有设置大小以及位置。因此浏览器生成渲染树后，会根据渲染树进行布局，设置各个节点的确切位置，这个过程被称为**回流**。
* 布局阶段结束后是绘制阶段，遍历渲染树并且通过`paint`方法将内容显示在屏幕，绘制`UI`组件。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d69da20c3f84782948226798effc60a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**注意：**浏览器渲染的过程是逐步完成的，但是为了更好的用户体验，浏览器并不会等所有的`HTML`和`CSS`解析完在生成渲染树，而是解析一部分，渲染一部分，显示一部分，提高用户体验。

### 2. 浏览器渲染优化

**JavaScript**

浏览器在加载`JavaScript`文件时，会阻塞当前`HTML`和`CSS`文件的解析，因此我们可以对`JavaScript`文件加载方式进行优化。

* 尽量把`JavaScript`文件放在`body`底部，`body`中间不要添加`JavaScript`文件。
* `script`标签添加`async`或者`defer`属性，异步加载`JavaScript`文件，不会阻塞当前`DOM`的解析。

**CSS**

`CSS`文件导入有三种方式，分别为`link`，`@import`和内联样式，其中`link`和`@import`都是导入外部样式。

* **link**标签会创建一个新的`http`线程加载资源，同时`GUI`也会继续向下渲染代码。
* **@import**会让`GUI`渲染线程暂停渲染，去服务器加载资源文件，在资源没有返回之前不会渲染。
* **style**，GUI直接渲染

所以在开发过程中，尽量使用`link`加载外部样式，如果样式较少，直接写在`style`标签当中或者使用内嵌样式。

**针对DOM树、CSSOM树**

* `HTML`文件的代码层级不要太深。
* 使用语义化标签，便于浏览器解析。
* 减少`CSS`代码的层级，选择器从左至右解析。

**减少回流与重绘**

**回流一定引发重绘，重绘不一定引发回流**。

* 当 Render Tree 中部分或全部元素的尺寸、结构、或某些属性发生改变时,浏览器重新渲染部分或全部文档的过程称为回流。

* 当页面中元素样式的改变并不影响它在文档流中的位置时（例如：color、background-color、visibility 等）,浏览器会将新样式赋予给元素并重新绘制它,这个过程称为重绘。

* 现代浏览器对频繁的回流与重绘进行了优化，浏览器会维护一个队列，把所有引发回流重绘的操作放入队列中，如果队列中的任务数量或者时间间隔到达一定的阈值，浏览器会清空队列，进行一次批处理。

### 3. 渲染过程中遇到 JS 文件如何处理？

`JavaScript`文件的加载，编译与执行会阻塞文档的解析。因此，在构建`DOM`时，`HTML`解析器如果遇到`JavaScript`文件，会暂停文档的解析，将控制权移交给`JavaScript`引擎，等`JavaScript`引擎运行完毕，浏览器再从文档中断的地方继续解析文档。

如果想要首屏渲染速度加快，应当把`script`标签放到`body`标签的底部，或者给`script`标签添加`defer`或者`async`属性。

### 4. 什么是文档的预解析？

浏览器执行`JavaScript`脚本时，另一个线程会解析剩下的文档，并且加载相应的网络资源。预解析不会改变`DOM`树，而只是加载网络资源，如图片，样式表，外部脚本等。

### 5. CSS 如何阻塞文档解析?

理论上`CSS`不影响HTML文档解析生成`DOM`树，但是执行`JavaScript`脚本文件时，可能会请求样式信息，如果样式还没有加载和解析，就会产生错误的值。所以如果浏览器还没有完成`CSSOM`的下载和构建，浏览器会延迟`JavaScript`脚本的延迟和文档解析，直至`CSSOM`的下载和构建完成为止。

### 6. 什么是 CRP,即关键渲染路径(Critical Rendering Path)? 如何优化 

CRP是指浏览器将`HTML`，`CSS`，`JavaScript`转化为像素内容呈现在屏幕上的一系列步骤，即浏览器的渲染流程。

为尽快完成首次渲染,我们需要最大限度减小以下三种可变因素：

* 减少关键资源渲染的数量：可能组织网页渲染的资源。
* 减少关键资源渲染的字节：首次渲染所需的总字节。
* 减少关键资源的路径长度：获取所有关键资源所需的往返次数或总时间。

### 7. 什么情况会阻塞渲染？

渲染的前提是生成渲染树，所以`HTML`和`CSS`的加载解析会阻塞渲染，我们应当降低首次渲染所需的文件字节大小，压缩文件，优化选择器。然后当浏览器在解析到 `script` 标签时，会暂停构建 `DOM`，完成后才会从暂停的地方重新开始。我们可以把`script`标签放在底部或者添加异步属性。

