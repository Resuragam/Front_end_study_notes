## DNS协议介绍

### 1. DNS 协议是什么

`DNS`是域名系统（Domain Name System）的缩写，提供的是一种主机名到`IP`地址的转换服务，就是我们常说的域名系统。它是由一个分层的`DNS`服务器组成的分布式数据库，定义主机如何查询这个分布式数据库的方式的应用层协议。帮助人们更加方便地访问互联网，而不用记住繁琐的`IP`地址。

**作用：**将域名解析称为`IP`地址，客户端向服务器发送域名查询请求，`DNS`服务器告诉客户端`Web`服务器的`IP`地址。

### 2. DNS同时使用TCP和UDP协议？

`DNS`占用53号端口，同时使用`TCP`和`UDP`协议。

* **在区域传输内使用TCP协议。**

  辅助域名服务器会每隔一段时间向主域名服务器进行查询以便于了解数据是否进行变动。如果变动，会执行一次区域传输，进行数据同步。区域传送使用`TCP`而不是`UDP`，因为区域传输的数据量较大，远远大于一次请求响应。`TCP`是一种可靠连接，保证了数据的准确性。

* **在域名查询使用UDP协议。**

  在客户端域名查询时，一般返回的内容较小，可以使用`UDP`传输。不需要`TCP`连接的三次握手，可以降低`DNS`服务器的负载，效率更高。理论上，客户端也可以指定向`DNS`服务器查询时使用`TCP`协议，但是绝大多数的`DNS`服务器进行配置的时候只支持`UDP`查询包。

### 3. DNS完整的查询过程

* 浏览器输入域名，首先会先**浏览器缓存**查询IP地址，如果查找到直接返回，没有就继续下一步。
* 将请求发送给**本地`DNS`服务器**，在本地域名服务器缓存中查询，如果查找到直接返回，没有就继续下一步。
* 本地`DNS`服务器向**根域名服务器**发送请求，根域名服务器会返回一个顶级域名服务器的IP地址。
* 本地`DNS`服务器向**顶级域名服务器**发送请求，顶级域名服务器会返回一个权威域名服务器的IP地址。
* 本地`DNS`服务器向**权威域名服务器**发送请求，权威域名服务器会返回查询域名的IP地址。
* 本地`DNS`服务器拿到IP地址，将结果缓存起来，方便下次查询。
* 本地`DNS`服务器将返回结果返回给浏览器。

### 4. 迭代查询与递归查询

`DNS`解析实际上是一个迭代查询和递归查询的过程。

* **递归查询**是指查询请求发出之后，域名服务器代为向下一级域名服务器发送请求，最后向用户发送请求结果。使用递归查询，用户只需要发送一次请求。
* **迭代查询**是指发送查询请求，域名服务器返回单次查询结果。下一级查询由用户自身发送请求。使用迭代查询，用户需要多次发送请求。

一般我们向本地`DNS`发送请求时递归查询，因此我们只需要发送一次请求，然后本地`DNS`服务器就可以拿到最终的执行结果。而本地`DNS`服务器向各级域名服务器查询的过程是迭代查询，每个查询只返回单次查询的结果，下一次查询由本地`DNS`服务器自己发送。

### 5. DNS 记录和报文

`DNS`服务器中以资源记录的形式存储信息，每一个`DNS`响应报文一般包含多条信息，格式一般如下：

~~~http
（Name，Value，Type，TTL）
~~~

其中 TTL 是资源记录的生存时间，它定义了资源记录能够被其他的 DNS 服务器缓存多长时间。

其他`Type`一共有四个值，分别是`A`，`NA`，`CNAME`，`MX`，不同的`Type`，代表着缓存资源的意义不一样。

* `Type` 等于`A`，`Name`表示主机名，`Value`表示主机的`IP`地址。
* `Type` 等于`NA`，`Name`表示域名，`Value`表示负责该域名的`DNS`服务器主机名。
* `Type` 等于`CNAME`，`Name`表示别名，`Value`表示主机的规范名称。
* `Type` 等于`MX`，Name表示邮件服务器的别名，`Value`表示邮件服务器的主机名。