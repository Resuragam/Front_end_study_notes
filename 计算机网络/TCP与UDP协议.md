## TCP与UDP

### 1. TCP 和 UDP的概念及特点

`TCP`和`UDP`都是传输层协议。

#### TCP

`TCP`协议是全称是传输控制协议，是一种面向连接，可靠的，基于字节流的传输通信协议。

它有如下几个特点：

* 面向连接，`TCP`协议在发送数据之前必须在两端建立连接，通过三次握手建立连接，为数据的可靠传输打下基础。
* 仅支持单向传输，每次`TCP`连接都需要两个端点，只能进行点对点的数据传输，不支持广播和多播。
* 面向字节流，在不保留报文边界的情况下以字节流的方式进行传输。
* 可靠传输。`TCP`为了保证报文传输的可靠，就给每个包一个序号，同时保证接收方按序接受包。然后接收端对已经成功收到的字节发送一个相应的ACK确认；如果在往返时延中未收到确认，那么对应的数据就会重传。
* 当网络出现拥塞的时候，`TCP`会减少向网络中注射的速率与数量，缓解拥塞。
* `TCP`提供全双工通信，`TCP`连接的双方都设置有缓存，用来存放双向通信的数据。当然，`TCP`可以立即发送一个数据段，也可以缓存一段时间以便一次发送更多的数据段（最大的数据段大小取决于`MSS`）。

#### UDP

`UDP`协议是用户数据报协议，是面向数据报的无连接协议。

* 面向无连接的。`UDP`协议不需要`TCP`协议一样三次握手，它只要在发送前，给数据增加一个`UDP`头标识就是`UDP`协议，在接收方只要去除`IP`报文头就传递给应用层，不会进行其他操作。
* `UDP`协议支持单播，多播，广播的传输方式。
* 面向报文的。`UDP`协议在传输发送前只需要给数据添加一个`UDP`头标识，在接收方只要去除`IP`报文头就传递给应用层。
* 不可靠性。`UDP`协议的不可靠性体现在无连接上，随时发送数据，同时也不会关心数据是否准备送达。对与网络环境也没有拥塞控制，一直以恒定的速率发送数据，不会根据当前网络环境调整发送速率。

### 2. TCP和UDP的区别

* `TCP`是面向连接的，`UDP`面向无连接的。
* `TCP`是可靠传输的，保证传输的顺序与正确性，使用流量控制和拥塞控制，`UDP`是不可靠传输的，无法进行流量控制和拥塞控制。
* `TCP`仅支持单播通信，`UDP`支持单播，多播，广播通信。
* `TCP`是面向字节流的，`UDP`是面向数据报的。
* `TCP`首部开销小，`UDP`首部开销大。
* `TCP`只要应用于文件传输，需要确保可靠传输的场景，`UDP`多应用于实时场景，例如视频通信，直播等。

### 3. TCP和UDP的使用场景

**TCP应用场景：**应用于效率较慢，但是准确率要求较高的场景，比如文件传输。

**UDP应用场景：**应用于效率较高，准确率较低的场景，比如QQ聊天、在线视频、网络语音电话等。

### 4. UDP协议为什么不可靠？

* 不保证消息交付的准确性，对于丢包的数据不会进行重传。
* 不保证数据包的顺序，不设置序号段，无法进行重排。
* 不跟踪连接状态，面向无连接。
* 不进行拥塞控制，没有内置网络的反馈机制。

### 5. TCP的重传机制

`TCP`协议为了保证数据传输的可靠性，在每一个发送数据时，都会设置一个定时器，当在这个时间内没有收到这个包的`ACK`确认报文，会对该数据报文进行重传，在达到一定次数时会放弃并发送一个复位信号。

### 6. TCP的拥塞控制机制

`TCP`的拥塞控制主要原理依赖于一个拥塞窗口(cwnd)来控制和一个慢启动门限阈值来设置的。

#### 慢启动

 慢启动通过逐步增大拥塞窗口的值来控制网络拥塞。拥塞窗口的初始值为1，每经过一个传输轮次，拥塞窗口的值就会*2。当拥塞窗口的值超过阈值时，会进入拥塞避免阶段。

#### 拥塞避免

拥塞避免主要思路是让拥塞窗口缓存增长，每经过一个传输轮次，拥塞窗口的值就会加一。

每当收到一个`ACK`，`cwnd = cwnd + 1/cwnd`。

每当过了一个`RTT`，`cwnd = cwnd + 1`。

#### 快重传

当网络拥塞并且出现丢包现象时，接收方会对失序的报文立即发出重复确认。当连续发送三个重复确认就应该立即重传未被确认的报文段。

并且此时阈值改为当前拥塞窗口的一半，拥塞窗口的大小设置为阈值相同大小，重新进入拥塞避免阶段。

#### 快速恢复

当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，把慢开始门限减半。但接下去不执行慢开始算法。

### 7. TCP的流量控制机制

`TCP`的流量控制机制主要是针对接受方设置的机制，为了让发送方发送数据的速度不要太快，要接收方及时接受数据。

`TCP`采用大小可变的**滑动窗口**进行流量控制，窗口大小的单位是字节。这里说的窗口大小其实就是每次传输的数据大小。

* 当一个连接建立时，连接的每一端会设置一个缓存区来保存输入的数据，并将缓冲区的大小发给另一端。
* 当数据到达时，接收方发送确认，并包含当前自己的缓冲区的大小（指出窗口大小被称为窗口通告）。
* 如果接受方接收数据的速度和数据到达的速度一样快，那缓存区的大小始终为正，如果小于数据到达的速度，那么缓冲区的大小会逐渐较小并且最后变为0，此时会发送一个零窗口的通告。发送方收到通告后会停止发送，直到接收方发送一个正的窗口通告。

### 8. TCP的可靠传输机制

### 9. TCP的三次握手和四次挥手

#### 三次挥手

`TCP`进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备。实质上其实就是连接服务器指定端口，建立TCP连接，并同步连接双方的序列号和确认号，交换TCP窗口大小信息。

- 第一次握手：客户端给服务端发一个 SYN 报文，并指明客户端的初始化序列号 ISN，此时客户端处于 SYN_SEND 状态。
- 第二次握手：服务器收到客户端的 SYN 报文之后，会以自己的 SYN 报文作为应答，并且也是指定了自己的初始化序列号 ISN。同时会把客户端的 ISN + 1 作为ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于 SYN_REVD 的状态。
- 客户端收到 SYN 报文之后，会发送一个 ACK 报文，当然，也是一样把服务器的 ISN + 1 作为 ACK 的值，表示已经收到了服务端的 SYN 报文，此时客户端处于 ESTABLISHED 状态。服务器收到 ACK 报文之后，也处于 ESTABLISHED 状态，此时，双方已建立起了连接。

#### 四次握手